package com.example.common;

import java.io.IOException;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.net.SocketException;
import java.util.ArrayList;

import com.example.datadiagramsocket.MainActivity;
import com.example.datadiagramsocket.R;

import android.app.Activity;
import android.content.Intent;
import android.os.AsyncTask;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.view.View;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

public class DisplayActivity extends Activity {
	
	public TextView m_SystemTimeTextView;
	public ListView m_SystemTimeListView;
	public Button m_CancelButton;
	static Handler handerThr;
	

	int clickCounter=0;
	ArrayList<String> listItems=new ArrayList<String>();
	ArrayAdapter<String> adapter;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.display_screen);
		
		m_SystemTimeListView = (ListView)findViewById(R.id.lvListSystemTime);  
				
		adapter = new ArrayAdapter<String>(this,R.layout.listview, listItems);
		
		m_SystemTimeListView.setAdapter(adapter);
		
		handerThr = new Handler();
		Thread t = new Thread(new ThreadSocket());
    		t.start();
    		
	}
	public void btnCancel_OnClick(View view){
		/*Intent i= new Intent(DisplayActivity.this,MainActivity.class);
		startActivity(i);
		finish();*/
		//dùng để update list view
		listItems.add("Clicked : "+clickCounter++);
        adapter.notifyDataSetChanged();
        ////////////
	}
	public class ThreadSocket implements Runnable{
		@Override
		public void run() {
			while(true){
						try {	    		
						   byte[] message = new byte[127];
							    	
							DatagramPacket p = new DatagramPacket(message, message.length); 
						
			
							 DatagramSocket	s = new DatagramSocket(5000);
							 s.setSoTimeout(10000);			
							 s.receive(p);
							 handerThr.post(new updateThread(p.getData()));
							 
						} catch (IOException e) {
									// TODO Auto-generated catch block
							e.printStackTrace();
						} 		    	
					}	
			}			
	}
	public class updateThread implements Runnable{

		String msg;
		updateThread(byte[] Message){
			msg=new String(Message, 0, Message.length);
		}
		
		@Override
		public void run() {
			// TODO Auto-generated method stub
			if(msg!=null){
				listItems.add(msg);
		        adapter.notifyDataSetChanged();
		      //  msg=null;
			}	
		}
		
	}
	
}
